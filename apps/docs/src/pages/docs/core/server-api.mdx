import { CodeBlock } from '@/components/code-block/code-block.kita';
import { DocsLayout } from '@/layouts/docs-layout';

export const layout = DocsLayout;

export const getMetadata = () => ({
  title: 'Docs | Server API',
  description: 'Learn how to use the Ecopages Server API',
})

# Server API

Ecopages provides a powerful server API that allows you to create endpoints and handle server-side logic with ease.

## Basic Usage

Create an `app.ts` file in your project root:

<CodeBlock>
```typescript
import { EcopagesApp } from '@ecopages/core/adapters/bun/create-app';
import appConfig from './eco.config';

const app = new EcopagesApp({ appConfig });

app.get('/api/hello', async () => {
  return new Response('Hello World');
});

await app.start();
```
</CodeBlock>

## HTTP Methods

The server supports all standard HTTP methods:

<CodeBlock>
```typescript
app.get('/api/resource', handler);
app.post('/api/resource', handler);
app.put('/api/resource', handler);
app.patch('/api/resource', handler);
app.delete('/api/resource', handler);
app.options('/api/resource', handler);
app.head('/api/resource', handler);
```
</CodeBlock>

## Route Parameters

You can define dynamic route parameters using the `:param` syntax:

<CodeBlock>
```typescript
app.get('/api/users/:id/posts/:postId', async ({ request }) => {
  const { id, postId } = request.params;
  return new Response(JSON.stringify({ userId: id, postId }));
});
```
</CodeBlock>

## Type Safety

The API handlers are fully typed, providing excellent TypeScript support:

<CodeBlock>
```typescript
import type { ApiHandler } from '@ecopages/core';

const handler: ApiHandler = {
  path: '/api/users/:id',
  method: 'GET',
  handler: async ({request}) => {
    const { id } = request.params;
    return new Response(JSON.stringify({ id }));
  },
};

app.get(handler.path, handler.handler);
```
</CodeBlock>

## Static Site Generation

During static site generation, the server can still handle API requests, making it possible to generate static content from API responses:

<CodeBlock>
```typescript
export const getStaticProps: GetStaticProps = async ({ appConfig }) => {
  const response = await fetch(`${appConfig.baseUrl}/api/data`);
  const data = await response.json();
  
  return {
    props: { data },
  };
};
```
</CodeBlock>

## Development Server

The development server includes:

- Hot Module Replacement (HMR) (beta)
- Automatic route reloading
- API endpoint hot reloading
- Static file serving
- Error handling with detailed stack traces

## Production Build

When building for production:

1. Static routes are pre-rendered
2. API routes are preserved for server-side handling
3. Assets are optimized and collected
4. Development-only code is stripped

## Error Handling

The server includes built-in error handling:

<CodeBlock>
```typescript
app.get('/api/error', async () => {
  throw new Error('Something went wrong');
  // Will return a 500 response with error details in development
  // and a safe error message in production
});
```
</CodeBlock>

## Configuration

Server configuration can be customized in your `eco.config.ts`:

<CodeBlock>
```typescript
const config = await new ConfigBuilder()
  .setBaseUrl('http://localhost:3000')
  // ... other config
  .build();
```
</CodeBlock>
