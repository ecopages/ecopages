import { DocsLayout } from '@/layouts/docs-layout';
import { Banner } from '@/components/banner/banner.kita';

export const config = {
  layout: DocsLayout,
};

export const getMetadata = () => ({
  title: 'Docs | Transitions',
  description: 'Add SPA-like client-side navigation and view transitions to your Ecopages application',
});


# Client-Side Navigation

The `@ecopages/browser-router` package enables Single Page Application (SPA) navigation behavior in your Ecopages application. It intercepts link clicks, fetches the next page via fetch, and uses [morphdom](https://github.com/patrick-steele-idem/morphdom) to efficiently diff and update only the parts of the DOM that changed.

This preserves element state (like audio players, web component internals, or form values) and enables native View Transitions.

<Banner type="alert">
  <Banner.Title>Framework Compatibility</Banner.Title>
  <p>This package works with MPA-style rendering (KitaJS, Lit, vanilla JS). <strong>Not compatible with React/Preact</strong>, these frameworks manage their own virtual DOM. For React apps, use a framework-specific routing solution.</p>
</Banner>

## Installation

```bash
bunx jsr add @ecopages/browser-router
```

## Setup

To enable client-side routing, initialize the router in your global script (e.g., `src/layouts/base-layout.script.ts`).

<Banner type="info">
  <Banner.Title>Consistent Head Ordering Required</Banner.Title>
  <p>To prevent "Flash of Unstyled Content" (FOUC), ensure the router script is injected in a <strong>consistent order</strong> within the <code>&lt;head&gt;</code> across all pages.</p>
  <p>Inconsistent ordering (e.g., script loaded between stylesheets on one page but after them on another) causes <code>morphdom</code> to detach and re-add stylesheets during navigation. Using a global layout script (like <code>base-layout.script.ts</code>) helps ensure this consistency.</p>
</Banner>

The simplest approach is to use `createRouter`, which creates and starts the router in one call:

```typescript
import { createRouter } from '@ecopages/browser-router/client';

const router = createRouter({
  viewTransitions: true,
});
```

For manual control over when the router starts and stops, use the `EcoRouter` class directly:

```typescript
import { EcoRouter } from '@ecopages/browser-router/client';

const router = new EcoRouter({
  viewTransitions: true,
});

router.start();

// Later, if needed:
// router.stop();
```

## Configuration

You can customize the router behavior by passing an options object:

| Option | Type | Default | Description |
| :--- | :--- | :--- | :--- |
| `linkSelector` | `string` | `'a[href]'` | Selector for links to intercept. |
| `persistAttribute` | `string` | `'data-eco-persist'` | Attribute to mark elements that should persist across navigations. |
| `reloadAttribute` | `string` | `'data-eco-reload'` | Attribute (on link or element) to force a full hard reload. |
| `scrollBehavior` | `'top' \| 'preserve' \| 'auto'` | `'top'` | Controls scroll behavior after navigation. |
| `viewTransitions` | `boolean` | `false` | Enables [View Transitions API](https://developer.mozilla.org/en-US/docs/Web/API/View_Transitions_API) support. |

### View Transitions

The browser router supports the native View Transitions API. 

To create a shared element transition, simply add the `data-view-transition` attribute to matching elements on different pages:

```html
<!-- Page 1 -->
<div data-view-transition="hero-1">...</div>

<!-- Page 2 -->
<div data-view-transition="hero-1">...</div>
```

The router automatically handles the transition names and ensures a clean "morph" animation (hiding the old snapshot to prevent ghosting) by default.

#### Directives

You can control the transition behavior using `data-view-transition-animate`:

| Value | Description |
| :--- | :--- |
| **`morph`** | (Default) Disables the cross-fade animation, resulting in a clean geometric morph. Ideal for shared element transitions to prevent "ghosting". |
| **`fade`** | Uses the standard browser cross-fade animation. Useful if you specifically want the old and new elements to fade into each other. |

```html
<!-- Example: Opt-out of the default morph -->
<div data-view-transition="hero-1" data-view-transition-animate="fade">...</div>

#### Duration

You can also control the speed of a specific transition using `data-view-transition-duration`:

```html
<div data-view-transition="hero-1" data-view-transition-duration="500ms">...</div>
```
```
| `updateHistory` | `boolean` | `true` | Whether to push a new entry to the browser history for each client-side navigation. |
| `smoothScroll` | `boolean` | `true` | Whether to use smooth scrolling when adjusting scroll position after navigation. |

### Example with Options

```typescript
const router = createRouter({
  viewTransitions: true,
  scrollBehavior: 'preserve',
  linkSelector: 'a:not([data-no-route])',
});
```

## Features

### Persistence

Elements marked with `data-eco-persist` are **never recreated** during navigation. morphdom recognizes these elements by their persist ID and skips updating them entirely, preserving their internal state (event listeners, web component state, form values, audio playback, etc.).

Add the `data-eco-persist` attribute with a unique ID:

```tsx
<audio 
  controls 
  src="/music.mp3" 
  data-eco-persist="global-player" 
/>
```

<Banner type="info">
  <Banner.Title>How It Works</Banner.Title>
  <p>Unlike traditional DOM swapping which destroys and recreates elements, morphdom diffs the current DOM against the new HTML. Persisted elements are matched by their ID and left untouched, keeping their internal state intact.</p>
</Banner>

### Script Re-execution

By default, scripts in the `<head>` are not re-executed during navigation if they already exist. However, some scripts (like hydration logic or analytics) need to run on every page load.

To force a script to re-execute on navigation:

1. Add `data-eco-rerun="true"` to force execution.
2. Add `data-eco-script-id="unique-id"` to identify the script (preventing duplicate downloads).

```html
<script 
  type="module" 
  data-eco-rerun="true" 
  data-eco-script-id="analytics-tracker"
>
  // This runs on initial load AND every navigation
  initAnalytics(window.location.pathname);
</script>
```

**How it works:**
- If the script with `data-eco-script-id` already exists, it is **not** re-downloaded.
- If it has `data-eco-rerun`, the router takes care of re-executing it.

### View Transitions

If `viewTransitions: true` is enabled, Ecopages will trigger a View Transition on navigation. You can customize the animation using standard CSS or the provided optional styles.

#### Using Included Styles

The package includes default fade and slide animations. Import them in your CSS:

```css
@import '@ecopages/browser-router/styles.css';
```

Then use the `data-eco-transition` attribute on elements to apply specific animations:

| Value | Description |
| :--- | :--- |
| `slide` | Slides the element horizontally during transition. |

```html
<main data-eco-transition="slide">
  <!-- Content slides in -->
</main>
```

## Lifecycle Events

The router emits lifecycle custom events on the `document` object, allowing you to hook into the navigation process.

| Event | Detail | Description |
| :--- | :--- | :--- |
| `eco:before-swap` | `{ url, direction, newDocument, reload }` | Fired after fetching new content but **before** updating the DOM. Use `newDocument` to inspect upcoming content. Call `reload()` to force a hard reload. |
| `eco:after-swap` | `{ url, direction }` | Fired **after** the DOM has been updated. Useful for re-initializing scripts or analytics. |
| `eco:page-load` | `{ url, direction }` | Fired on both initial load and subsequent navigations. |

### Example: Re-initializing Scripts

```typescript
document.addEventListener('eco:after-swap', () => {
  console.log('Page updated!');
  // Re-run any page-specific logic here
});
```

### Example: Navigation-Aware Components

For components that need to react to URL changes (like updating active states), listen for `eco:page-load`:

```typescript
document.addEventListener('eco:page-load', () => {
  // Update active states, re-highlight nav links, etc.
  highlightActiveLink();
});
```
