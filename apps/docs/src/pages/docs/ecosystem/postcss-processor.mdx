import { DocsLayout } from '@/layouts/docs-layout';

export const layout = DocsLayout;

export const getMetadata = () => ({
	title: 'Docs | PostCSS Processor',
	description: 'Learn how to use the PostCSS processor in Ecopages',
});

# PostCSS Processor

The `@ecopages/postcss-processor` package provides a PostCSS processor plugin for Ecopages and utility functions for processing CSS files and strings using PostCSS. It comes bundled with essential plugins like Tailwind CSS, Autoprefixer, and cssnano.

## Installation

Install the package from JSR:

```bash
bunx jsr add @ecopages/postcss-processor
```

## Built-in Plugins

The PostCSS processor comes with several built-in plugins:

- `postcss-import`: To transform `@import` rules by inlining content.
- `tailwindcss/nesting`: To enable Tailwind CSS nesting features.
- `tailwindcss`: The Tailwind CSS framework.
- `autoprefixer`: To add vendor prefixes to CSS rules.
- `cssnano`: For CSS optimization.

## Configuration

Integrate the processor into your Ecopages configuration:

```typescript
// ecopages.config.ts
import { ConfigBuilder } from '@ecopages/core';
import { postcssProcessorPlugin } from '@ecopages/postcss-processor';

const config = await new ConfigBuilder()
	.setProcessors([
		// Add the PostCSS processor plugin
		postcssProcessorPlugin({
			// Define a filter for files to process (defaults to /\.css$/)
			filter: /\.css$/,
			// Provide a function to transform input before processing
			transformInput: async (c) => `/* My Custom Header */\n${c}`,
			// Provide a function to transform output after processing
			transformOutput: async (css) => css.replace('blue', 'red'),
			// Explicitly provide plugins (overrides defaults)
			plugins: {
				/* custom plugins */
			},
		}),
	])
	.build();

export default config;
```

### Configuration Options

- `filter`: A Regex filter to match files to process (default: `/\.css$/`).
- `transformInput`: An optional function to transform the contents of the file before PostCSS processing.
- `transformOutput`: An optional function to transform the output CSS after PostCSS processing.
- `plugins`: An optional object containing custom PostCSS plugins to use instead of the default ones.

## PostCSS Config Support

The plugin automatically detects and uses `postcss.config.{js,cjs,mjs,ts}` from your project root if present. This is the recommended way to customize your PostCSS pipeline.

```javascript
// postcss.config.js
module.exports = {
	plugins: {
		'postcss-import': {},
		'tailwindcss/nesting': {},
		tailwindcss: {},
		autoprefixer: {},
		// Add or override plugins here
		'postcss-simple-vars': {},
		cssnano: {},
	},
};
```

## Using with Bun

To enable CSS imports in your TypeScript/JavaScript files, add the PostCSS loader to your `bunfig.toml`:

```toml
preload = ["@ecopages/bun-postcss-loader"]
```

Now you can import CSS files directly in your code:

```typescript
import styles from './styles.css';
```

## Custom Plugin Usage

You can also use the underlying processor functions directly and providing your own plugins:

```typescript
import { PostCssProcessor, defaultPlugins } from '@ecopages/postcss-processor';
import customPlugin from 'postcss-custom-plugin';

const result = await PostCssProcessor.processPath('path/to/file.css', {
	plugins: [
		defaultPlugins['postcss-import'],
		defaultPlugins.tailwindcss,
		defaultPlugins['tailwindcss-nesting'],
		defaultPlugins.autoprefixer,
		customPlugin(),
		defaultPlugins.cssnano,
	],
});
```

## Processing Methods

The processor provides two main methods for processing CSS standalone:

### Process File by Path

```typescript
import { PostCssProcessor } from '@ecopages/postcss-processor';

const css = await PostCssProcessor.processPath('path/to/file.css');
```

### Process String or Buffer

```typescript
import { PostCssProcessor } from '@ecopages/postcss-processor';

const css = `body { @apply bg-blue-500; }`;
const processed = await PostCssProcessor.processStringOrBuffer(css, { filePath: 'style.css' });
```

## Error Handling

The processor includes built-in error handling:

- File not found errors are thrown with clear messages.
- Processing errors are caught and logged.
- On error, processing methods return an empty string instead of failing.
```
